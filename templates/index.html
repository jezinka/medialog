<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Media Log - Dziennik KsiƒÖ≈ºek i Seriali</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>Media Log - {{ year }}</h1>
            <div class="year-navigation">
                <button onclick="changeYear(-1)">‚Üê {{ year - 1 }}</button>
                <button onclick="changeYear(0)">Bie≈ºƒÖcy rok</button>
                <button onclick="changeYear(1)">{{ year + 1 }} ‚Üí</button>
            </div>
        </header>

        <div class="add-media-section">
            <h2 onclick="toggleForm()">
                Dodaj nowƒÖ pozycjƒô 
                <span class="toggle-icon" id="toggleIcon">‚ñº</span>
            </h2>
            <div class="form-container" id="formContainer">
                <form id="addMediaForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="title">Tytu≈Ç:</label>
                            <input type="text" id="title" name="title" required>
                        </div>
                        <div class="form-group">
                            <label for="mediaType">Typ:</label>
                            <select id="mediaType" name="mediaType" required>
                                <option value="book">KsiƒÖ≈ºka</option>
                                <option value="series">Serial/Film</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="startDate">Data rozpoczƒôcia:</label>
                            <input type="date" id="startDate" name="startDate" required>
                        </div>
                        <div class="form-group">
                            <label for="endDate">Data zako≈Ñczenia:</label>
                            <input type="date" id="endDate" name="endDate" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="notes">Notatki (opcjonalne):</label>
                        <textarea id="notes" name="notes" rows="2"></textarea>
                    </div>
                    <button type="submit" class="submit-btn">Dodaj</button>
                </form>
            </div>
        </div>

        <div class="summary-section">
            <h2>üìä Podsumowanie</h2>
            <div class="summary-controls">
                <select id="summaryYear">
                    <option value="{{ year }}">{{ year }}</option>
                </select>
                <select id="summaryMonth">
                    <option value="">Ca≈Çy rok</option>
                    <option value="1">Stycze≈Ñ</option>
                    <option value="2">Luty</option>
                    <option value="3">Marzec</option>
                    <option value="4">Kwiecie≈Ñ</option>
                    <option value="5">Maj</option>
                    <option value="6">Czerwiec</option>
                    <option value="7">Lipiec</option>
                    <option value="8">Sierpie≈Ñ</option>
                    <option value="9">Wrzesie≈Ñ</option>
                    <option value="10">Pa≈∫dziernik</option>
                    <option value="11">Listopad</option>
                    <option value="12">Grudzie≈Ñ</option>
                </select>
                <button class="summary-btn" onclick="generateSummary()">Generuj podsumowanie</button>
            </div>
            <div id="summaryContent"></div>
        </div>

        <div class="calendars-container">
            <div class="calendar-section">
                <h2>üìö KsiƒÖ≈ºki</h2>
                <div id="booksCalendar" class="calendar"></div>
            </div>

            <div class="calendar-section">
                <h2>üé¨ Seriale i Filmy</h2>
                <div id="seriesCalendar" class="calendar"></div>
            </div>
        </div>

        <div class="media-list-section">
            <h2>Lista pozycji</h2>
            <div id="mediaList"></div>
        </div>
    </div>

    <script>
        let currentYear = {{ year }};
        let allMedia = [];

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadMedia();
            populateYearDropdown();
        });

        function toggleForm() {
            const container = document.getElementById('formContainer');
            const icon = document.getElementById('toggleIcon');
            
            if (container.classList.contains('expanded')) {
                container.classList.remove('expanded');
                icon.classList.add('collapsed');
            } else {
                container.classList.add('expanded');
                icon.classList.remove('collapsed');
            }
        }

        function populateYearDropdown() {
            const yearSelect = document.getElementById('summaryYear');
            const currentYear = new Date().getFullYear();
            yearSelect.innerHTML = '';
            
            for (let year = currentYear - 5; year <= currentYear + 1; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                if (year === currentYear) {
                    option.selected = true;
                }
                yearSelect.appendChild(option);
            }
        }

        function changeYear(offset) {
            if (offset === 0) {
                currentYear = new Date().getFullYear();
            } else {
                currentYear += offset;
            }
            window.location.href = `/?year=${currentYear}`;
        }

        async function loadMedia() {
            try {
                const response = await fetch(`/api/media?year=${currentYear}`);
                allMedia = await response.json();
                
                renderCalendars(allMedia);
                renderMediaList(allMedia);
            } catch (error) {
                console.error('Error loading media:', error);
            }
        }

        async function generateSummary() {
            const year = document.getElementById('summaryYear').value;
            const month = document.getElementById('summaryMonth').value;
            
            try {
                const response = await fetch(`/api/media?year=${year}`);
                const media = await response.json();
                
                let filteredMedia = media;
                if (month) {
                    filteredMedia = media.filter(item => {
                        const startDate = new Date(item.start_date);
                        const endDate = new Date(item.end_date);
                        const monthInt = parseInt(month);
                        
                        // Check if the media was consumed during the selected month
                        return (startDate.getMonth() + 1 <= monthInt && endDate.getMonth() + 1 >= monthInt &&
                                startDate.getFullYear() == year && endDate.getFullYear() == year) ||
                               (startDate.getMonth() + 1 == monthInt || endDate.getMonth() + 1 == monthInt);
                    });
                }
                
                displaySummary(filteredMedia, year, month);
            } catch (error) {
                console.error('Error generating summary:', error);
            }
        }

        function displaySummary(media, year, month) {
            const container = document.getElementById('summaryContent');
            
            if (media.length === 0) {
                container.innerHTML = '<p style="text-align: center; opacity: 0.8;">Brak danych do wy≈õwietlenia</p>';
                return;
            }
            
            const books = media.filter(m => m.media_type === 'book');
            const series = media.filter(m => m.media_type === 'series');
            
            const totalDaysBooks = books.reduce((sum, item) => {
                const start = new Date(item.start_date);
                const end = new Date(item.end_date);
                const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
                return sum + days;
            }, 0);
            
            const totalDaysSeries = series.reduce((sum, item) => {
                const start = new Date(item.start_date);
                const end = new Date(item.end_date);
                const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
                return sum + days;
            }, 0);
            
            const monthNames = ['', 'Stycze≈Ñ', 'Luty', 'Marzec', 'Kwiecie≈Ñ', 'Maj', 'Czerwiec', 
                              'Lipiec', 'Sierpie≈Ñ', 'Wrzesie≈Ñ', 'Pa≈∫dziernik', 'Listopad', 'Grudzie≈Ñ'];
            const periodText = month ? `${monthNames[month]} ${year}` : `Rok ${year}`;
            
            let html = `<h3 style="margin-bottom: 15px;">Podsumowanie: ${periodText}</h3>`;
            html += '<div class="summary-grid">';
            html += `
                <div class="summary-item">
                    <div class="summary-item-value">${books.length}</div>
                    <div class="summary-item-label">Przeczytanych ksiƒÖ≈ºek</div>
                </div>
                <div class="summary-item">
                    <div class="summary-item-value">${series.length}</div>
                    <div class="summary-item-label">Obejrzanych seriali/film√≥w</div>
                </div>
                <div class="summary-item">
                    <div class="summary-item-value">${totalDaysBooks}</div>
                    <div class="summary-item-label">Dni czytania</div>
                </div>
                <div class="summary-item">
                    <div class="summary-item-value">${totalDaysSeries}</div>
                    <div class="summary-item-label">Dni oglƒÖdania</div>
                </div>
            `;
            html += '</div>';
            
            if (books.length > 0) {
                html += '<div class="summary-list">';
                html += '<h4 style="margin-bottom: 10px;">üìö KsiƒÖ≈ºki:</h4>';
                books.forEach(book => {
                    const start = new Date(book.start_date);
                    const end = new Date(book.end_date);
                    const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
                    html += `
                        <div class="summary-list-item">
                            <span class="summary-list-title">${book.title}</span>
                            <span class="summary-list-days">${days} dni</span>
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            if (series.length > 0) {
                html += '<div class="summary-list">';
                html += '<h4 style="margin-bottom: 10px;">üé¨ Seriale i Filmy:</h4>';
                series.forEach(item => {
                    const start = new Date(item.start_date);
                    const end = new Date(item.end_date);
                    const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
                    html += `
                        <div class="summary-list-item">
                            <span class="summary-list-title">${item.title}</span>
                            <span class="summary-list-days">${days} dni</span>
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            container.innerHTML = html;
        }

        function renderCalendars(media) {
            const books = media.filter(m => m.media_type === 'book');
            const series = media.filter(m => m.media_type === 'series');
            
            renderCalendar('booksCalendar', books, currentYear);
            renderCalendar('seriesCalendar', series, currentYear);
        }

        function renderCalendar(elementId, mediaItems, year) {
            const container = document.getElementById(elementId);
            container.innerHTML = '';
            
            const months = [
                'Stycze≈Ñ', 'Luty', 'Marzec', 'Kwiecie≈Ñ', 'Maj', 'Czerwiec',
                'Lipiec', 'Sierpie≈Ñ', 'Wrzesie≈Ñ', 'Pa≈∫dziernik', 'Listopad', 'Grudzie≈Ñ'
            ];
            
            for (let month = 0; month < 12; month++) {
                const monthDiv = document.createElement('div');
                monthDiv.className = 'month';
                
                const monthHeader = document.createElement('div');
                monthHeader.className = 'month-header';
                monthHeader.textContent = months[month];
                monthDiv.appendChild(monthHeader);
                
                const daysGrid = document.createElement('div');
                daysGrid.className = 'days-grid';
                
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const firstDay = new Date(year, month, 1).getDay();
                const startDay = firstDay === 0 ? 6 : firstDay - 1; // Monday = 0
                
                // Add day headers
                const dayHeaders = ['Pn', 'Wt', '≈ör', 'Cz', 'Pt', 'So', 'Nd'];
                dayHeaders.forEach(day => {
                    const dayHeader = document.createElement('div');
                    dayHeader.className = 'day-header';
                    dayHeader.textContent = day;
                    daysGrid.appendChild(dayHeader);
                });
                
                // Add empty cells for days before month starts
                for (let i = 0; i < startDay; i++) {
                    const emptyDay = document.createElement('div');
                    emptyDay.className = 'day empty';
                    daysGrid.appendChild(emptyDay);
                }
                
                // Add days
                for (let day = 1; day <= daysInMonth; day++) {
                    const dayDiv = document.createElement('div');
                    dayDiv.className = 'day';
                    dayDiv.textContent = day;
                    
                    const currentDate = new Date(year, month, day);
                    const dateStr = currentDate.toISOString().split('T')[0];
                    
                    // Check if this day is covered by any media item
                    const mediaOnDay = mediaItems.filter(item => {
                        const start = new Date(item.start_date);
                        const end = new Date(item.end_date);
                        return currentDate >= start && currentDate <= end;
                    });
                    
                    if (mediaOnDay.length > 0) {
                        dayDiv.classList.add('has-media');
                        dayDiv.title = mediaOnDay.map(m => m.title).join(', ');
                    }
                    
                    daysGrid.appendChild(dayDiv);
                }
                
                monthDiv.appendChild(daysGrid);
                container.appendChild(monthDiv);
            }
        }

        function renderMediaList(media) {
            const container = document.getElementById('mediaList');
            container.innerHTML = '';
            
            if (media.length === 0) {
                container.innerHTML = '<p class="empty-message">Brak wpis√≥w w tym roku.</p>';
                return;
            }
            
            const books = media.filter(m => m.media_type === 'book');
            const series = media.filter(m => m.media_type === 'series');
            
            if (books.length > 0) {
                const booksSection = document.createElement('div');
                booksSection.className = 'media-category';
                booksSection.innerHTML = '<h3>üìö KsiƒÖ≈ºki</h3>';
                books.forEach(item => {
                    booksSection.appendChild(createMediaItem(item));
                });
                container.appendChild(booksSection);
            }
            
            if (series.length > 0) {
                const seriesSection = document.createElement('div');
                seriesSection.className = 'media-category';
                seriesSection.innerHTML = '<h3>üé¨ Seriale i Filmy</h3>';
                series.forEach(item => {
                    seriesSection.appendChild(createMediaItem(item));
                });
                container.appendChild(seriesSection);
            }
        }

        function createMediaItem(item) {
            const div = document.createElement('div');
            div.className = 'media-item';
            
            const content = `
                <div class="media-item-header">
                    <strong>${item.title}</strong>
                    <button onclick="deleteMedia(${item.id})" class="delete-btn">Usu≈Ñ</button>
                </div>
                <div class="media-item-details">
                    <span>Od: ${formatDate(item.start_date)}</span>
                    <span>Do: ${formatDate(item.end_date)}</span>
                    <span>${calculateDays(item.start_date, item.end_date)} dni</span>
                </div>
                ${item.notes ? `<div class="media-item-notes">${item.notes}</div>` : ''}
            `;
            
            div.innerHTML = content;
            return div;
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('pl-PL');
        }

        function calculateDays(startStr, endStr) {
            const start = new Date(startStr);
            const end = new Date(endStr);
            const diffTime = Math.abs(end - start);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
            return diffDays;
        }

        document.getElementById('addMediaForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                title: document.getElementById('title').value,
                media_type: document.getElementById('mediaType').value,
                start_date: document.getElementById('startDate').value,
                end_date: document.getElementById('endDate').value,
                notes: document.getElementById('notes').value
            };
            
            try {
                const response = await fetch('/api/media', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                if (response.ok) {
                    alert('Pozycja zosta≈Ça dodana!');
                    this.reset();
                    loadMedia();
                } else {
                    const error = await response.json();
                    alert('B≈ÇƒÖd: ' + error.error);
                }
            } catch (error) {
                console.error('Error adding media:', error);
                alert('WystƒÖpi≈Ç b≈ÇƒÖd podczas dodawania pozycji.');
            }
        });

        async function deleteMedia(id) {
            if (!confirm('Czy na pewno chcesz usunƒÖƒá tƒô pozycjƒô?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/media/${id}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    alert('Pozycja zosta≈Ça usuniƒôta!');
                    loadMedia();
                } else {
                    alert('B≈ÇƒÖd podczas usuwania pozycji.');
                }
            } catch (error) {
                console.error('Error deleting media:', error);
                alert('WystƒÖpi≈Ç b≈ÇƒÖd podczas usuwania pozycji.');
            }
        }
    </script>
</body>
</html>
