<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Media Log - Dziennik KsiƒÖ≈ºek i Seriali</title>
    <link rel="stylesheet" href="/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Media Log - <%= year %></h1>
            <div class="year-navigation">
                <button data-action="changeYear" data-delta="-1">‚Üê <%= year - 1 %></button>
                <button data-action="changeYear" data-delta="0">Bie≈ºƒÖcy rok</button>
                <button data-action="changeYear" data-delta="1"><%= year + 1 %> ‚Üí</button>
            </div>
        </header>

        <div class="add-media-section">
            <h2 data-action="toggleForm">
                Dodaj nowƒÖ pozycjƒô 
                <span class="toggle-icon" id="toggleIcon">‚ñº</span>
            </h2>
            <div class="form-container" id="formContainer">
                <form id="addMediaForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="title">Tytu≈Ç:</label>
                            <input type="text" id="title" name="title" required>
                        </div>
                        <div class="form-group">
                            <label for="author">Autor:</label>
                            <input type="text" id="author" name="author" placeholder="Opcjonalnie">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="mediaType">Typ:</label>
                            <select id="mediaType" name="mediaType" required>
                                <option value="book">üìñ KsiƒÖ≈ºka</option>
                                <option value="comic">üì∞ Komiks</option>
                                <option value="movie">üé¨ Film</option>
                                <option value="series">üì∫ Serial</option>
                                <option value="anime">üéå Anime</option>
                                <option value="cartoon">üé® Bajka</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="volumeEpisode">Tom/Odcinek:</label>
                            <input type="text" id="volumeEpisode" name="volumeEpisode" placeholder="Opcjonalnie">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="startDate">Data rozpoczƒôcia:</label>
                            <input type="date" id="startDate" name="startDate" required>
                        </div>
                        <div class="form-group">
                            <label for="endDate">Data zako≈Ñczenia:</label>
                            <input type="date" id="endDate" name="endDate" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="tags">Tagi (oddzielone przecinkami):</label>
                        <input type="text" id="tags" name="tags" placeholder="np. kino, akcja, polski">
                    </div>
                    <div class="form-group">
                        <label for="notes">Notatki (opcjonalne):</label>
                        <textarea id="notes" name="notes" rows="2"></textarea>
                    </div>
                    <button type="submit" class="submit-btn">Dodaj</button>
                </form>
            </div>
        </div>

        <div class="summary-section">
            <h2 data-action="toggleSummary" style="cursor: pointer;">
                üìä Podsumowanie 
                <span class="toggle-icon" id="summaryToggleIcon">‚ñº</span>
            </h2>
            <div class="summary-container" id="summaryContainer">
                <div class="summary-controls">
                    <select id="summaryYear">
                        <option value="<%= year %>"><%= year %></option>
                    </select>
                    <select id="summaryMonth">
                        <!-- Options populated dynamically by JavaScript -->
                    </select>
                    <button class="summary-btn" data-action="generateSummary">Generuj podsumowanie</button>
                </div>
                <div id="summaryContent"></div>
            </div>
        </div>

        <div class="calendars-container">
            <div class="calendar-section">
                <h2>üìö KsiƒÖ≈ºki</h2>
                <div id="booksCalendar" class="calendar"></div>
            </div>

            <div class="calendar-section">
                <h2>üé¨ Seriale i Filmy</h2>
                <div id="seriesCalendar" class="calendar"></div>
            </div>
        </div>

        <div class="media-list-section">
            <h2>Lista pozycji</h2>
            <div id="mediaList"></div>
        </div>
    </div>

    <script>
        let currentYear = <%= year %>;
        let allMedia = [];

        // Centralized month names (Polish localization)
        const MONTH_NAMES = [
            'Stycze≈Ñ', 'Luty', 'Marzec', 'Kwiecie≈Ñ', 'Maj', 'Czerwiec',
            'Lipiec', 'Sierpie≈Ñ', 'Wrzesie≈Ñ', 'Pa≈∫dziernik', 'Listopad', 'Grudzie≈Ñ'
        ];

        // Toast notification system
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icon = type === 'success' ? '‚úì' : '‚úó';
            
            toast.innerHTML = `
                <span class="toast-icon">${icon}</span>
                <span class="toast-message">${message}</span>
                <button class="toast-close" data-action="closeToast">√ó</button>
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadMedia();
            populateYearDropdown();
        });

        function toggleForm() {
            const container = document.getElementById('formContainer');
            const icon = document.getElementById('toggleIcon');
            
            if (container.classList.contains('expanded')) {
                container.classList.remove('expanded');
                icon.classList.add('collapsed');
            } else {
                container.classList.add('expanded');
                icon.classList.remove('collapsed');
            }
        }

        function toggleSummary() {
            const container = document.getElementById('summaryContainer');
            const icon = document.getElementById('summaryToggleIcon');
            
            if (container.classList.contains('expanded')) {
                container.classList.remove('expanded');
                icon.classList.add('collapsed');
            } else {
                container.classList.add('expanded');
                icon.classList.remove('collapsed');
            }
        }

        function populateYearDropdown() {
            const yearSelect = document.getElementById('summaryYear');
            const currentYear = new Date().getFullYear();
            yearSelect.innerHTML = '';
            
            for (let year = currentYear - 5; year <= currentYear + 1; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                if (year === currentYear) {
                    option.selected = true;
                }
                yearSelect.appendChild(option);
            }

            // Populate month dropdown
            const monthSelect = document.getElementById('summaryMonth');
            monthSelect.innerHTML = '<option value="">Ca≈Çy rok</option>';
            
            MONTH_NAMES.forEach((monthName, index) => {
                const option = document.createElement('option');
                option.value = index + 1;
                option.textContent = monthName;
                monthSelect.appendChild(option);
            });
        }

        function changeYear(offset) {
            if (offset === 0) {
                currentYear = new Date().getFullYear();
            } else {
                currentYear += offset;
            }
            window.location.href = `/?year=${currentYear}`;
        }

        async function loadMedia() {
            try {
                const response = await fetch(`/api/media?year=${currentYear}`);
                allMedia = await response.json();
                
                renderCalendars(allMedia);
                renderMediaList(allMedia);
            } catch (error) {
                console.error('Error loading media:', error);
            }
        }

        async function generateSummary() {
            const year = document.getElementById('summaryYear').value;
            const month = document.getElementById('summaryMonth').value;
            
            try {
                const response = await fetch(`/api/media?year=${year}`);
                const media = await response.json();
                
                let filteredMedia = media;
                if (month) {
                    filteredMedia = media.filter(item => {
                        const startDate = new Date(item.start_date);
                        const endDate = new Date(item.end_date);
                        const monthInt = parseInt(month);
                        
                        // Check if the media was consumed during the selected month
                        return (startDate.getMonth() + 1 <= monthInt && endDate.getMonth() + 1 >= monthInt &&
                                startDate.getFullYear() == year && endDate.getFullYear() == year) ||
                               (startDate.getMonth() + 1 == monthInt || endDate.getMonth() + 1 == monthInt);
                    });
                }
                
                displaySummary(filteredMedia, year, month);
            } catch (error) {
                console.error('Error generating summary:', error);
            }
        }

        function displaySummary(media, year, month) {
            const container = document.getElementById('summaryContent');
            
            if (media.length === 0) {
                container.innerHTML = '<p style="text-align: center; opacity: 0.8;">Brak danych do wy≈õwietlenia</p>';
                return;
            }
            
            const books = media.filter(m => m.media_type === 'book');
            const series = media.filter(m => m.media_type === 'series');
            
            const totalDaysBooks = books.reduce((sum, item) => {
                const start = new Date(item.start_date);
                const end = new Date(item.end_date);
                const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
                return sum + days;
            }, 0);
            
            const totalDaysSeries = series.reduce((sum, item) => {
                const start = new Date(item.start_date);
                const end = new Date(item.end_date);
                const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
                return sum + days;
            }, 0);
            
            const periodText = month ? `${MONTH_NAMES[month - 1]} ${year}` : `Rok ${year}`;
            
            let html = `<h3 style="margin-bottom: 15px;">Podsumowanie: ${periodText}</h3>`;
            html += '<div class="summary-grid">';
            html += `
                <div class="summary-item">
                    <div class="summary-item-value">${books.length}</div>
                    <div class="summary-item-label">Przeczytanych ksiƒÖ≈ºek</div>
                </div>
                <div class="summary-item">
                    <div class="summary-item-value">${series.length}</div>
                    <div class="summary-item-label">Obejrzanych seriali/film√≥w</div>
                </div>
                <div class="summary-item">
                    <div class="summary-item-value">${totalDaysBooks}</div>
                    <div class="summary-item-label">Dni czytania</div>
                </div>
                <div class="summary-item">
                    <div class="summary-item-value">${totalDaysSeries}</div>
                    <div class="summary-item-label">Dni oglƒÖdania</div>
                </div>
            `;
            html += '</div>';
            
            if (books.length > 0) {
                html += '<div class="summary-list">';
                html += '<h4 style="margin-bottom: 10px;">üìö KsiƒÖ≈ºki:</h4>';
                books.forEach(book => {
                    const start = new Date(book.start_date);
                    const end = new Date(book.end_date);
                    const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
                    html += `
                        <div class="summary-list-item">
                            <span class="summary-list-title">${book.title}</span>
                            <span class="summary-list-days">${days} dni</span>
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            if (series.length > 0) {
                html += '<div class="summary-list">';
                html += '<h4 style="margin-bottom: 10px;">üé¨ Seriale i Filmy:</h4>';
                series.forEach(item => {
                    const start = new Date(item.start_date);
                    const end = new Date(item.end_date);
                    const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
                    html += `
                        <div class="summary-list-item">
                            <span class="summary-list-title">${item.title}</span>
                            <span class="summary-list-days">${days} dni</span>
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            container.innerHTML = html;
        }

        function renderCalendars(media) {
            // Books calendar: books and comics
            const books = media.filter(m => m.media_type === 'book' || m.media_type === 'comic');
            // Visual media calendar: movies, series, anime, cartoons
            const visual = media.filter(m => ['movie', 'series', 'anime', 'cartoon'].includes(m.media_type));
            
            renderCalendar('booksCalendar', books, currentYear);
            renderCalendar('seriesCalendar', visual, currentYear);
        }

        function renderCalendar(elementId, mediaItems, year) {
            const container = document.getElementById(elementId);
            container.innerHTML = '';
            
            for (let month = 0; month < 12; month++) {
                const monthDiv = document.createElement('div');
                monthDiv.className = 'month';
                
                const monthHeader = document.createElement('div');
                monthHeader.className = 'month-header';
                monthHeader.textContent = MONTH_NAMES[month];
                monthDiv.appendChild(monthHeader);
                
                const daysGrid = document.createElement('div');
                daysGrid.className = 'days-grid';
                
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const firstDay = new Date(year, month, 1).getDay();
                const startDay = firstDay === 0 ? 6 : firstDay - 1; // Monday = 0
                
                // Add day headers
                const dayHeaders = ['Pn', 'Wt', '≈ör', 'Cz', 'Pt', 'So', 'Nd'];
                dayHeaders.forEach(day => {
                    const dayHeader = document.createElement('div');
                    dayHeader.className = 'day-header';
                    dayHeader.textContent = day;
                    daysGrid.appendChild(dayHeader);
                });
                
                // Add empty cells for days before month starts
                for (let i = 0; i < startDay; i++) {
                    const emptyDay = document.createElement('div');
                    emptyDay.className = 'day empty';
                    daysGrid.appendChild(emptyDay);
                }
                
                // Add days
                for (let day = 1; day <= daysInMonth; day++) {
                    const dayDiv = document.createElement('div');
                    dayDiv.className = 'day';
                    dayDiv.textContent = day;
                    
                    const currentDate = new Date(year, month, day);
                    const dateStr = currentDate.toISOString().split('T')[0];
                    
                    // Check if this day is covered by any media item
                    const mediaOnDay = mediaItems.filter(item => {
                        const start = new Date(item.start_date);
                        const end = new Date(item.end_date);
                        // FIX: Make date range inclusive by comparing dates only (not time)
                        start.setHours(0, 0, 0, 0);
                        end.setHours(0, 0, 0, 0);
                        currentDate.setHours(0, 0, 0, 0);
                        return currentDate >= start && currentDate <= end;
                    });
                    
                    if (mediaOnDay.length > 0) {
                        dayDiv.classList.add('has-media');
                        
                        // Get unique media types for this day
                        const types = [...new Set(mediaOnDay.map(m => m.media_type))];
                        
                        // Add type-specific classes for coloring
                        if (types.length === 1) {
                            dayDiv.classList.add(`media-${types[0]}`);
                        } else {
                            // Multiple types on same day - add a mixed class
                            dayDiv.classList.add('media-mixed');
                        }
                        
                        // Build tooltip with author info
                        const titlesList = mediaOnDay.map(m => {
                            let text = m.title;
                            if (m.author) text += ` - ${m.author}`;
                            if (m.volume_episode) text += ` (${m.volume_episode})`;
                            return text;
                        });
                        dayDiv.title = titlesList.join(', ');
                    }
                    
                    daysGrid.appendChild(dayDiv);
                }
                
                monthDiv.appendChild(daysGrid);
                container.appendChild(monthDiv);
            }
        }

        function renderMediaList(media) {
            const container = document.getElementById('mediaList');
            container.innerHTML = '';
            
            if (media.length === 0) {
                container.innerHTML = '<p class="empty-message">Brak wpis√≥w w tym roku.</p>';
                return;
            }
            
            // Group media by type
            const books = media.filter(m => m.media_type === 'book' || m.media_type === 'comic');
            const visual = media.filter(m => ['movie', 'series', 'anime', 'cartoon'].includes(m.media_type));
            
            if (books.length > 0) {
                const booksSection = document.createElement('div');
                booksSection.className = 'media-category';
                booksSection.innerHTML = '<h3>üìö KsiƒÖ≈ºki</h3>';
                books.forEach(item => {
                    booksSection.appendChild(createMediaItem(item));
                });
                container.appendChild(booksSection);
            }
            
            if (visual.length > 0) {
                const visualSection = document.createElement('div');
                visualSection.className = 'media-category';
                visualSection.innerHTML = '<h3>üé¨ Seriale i Filmy</h3>';
                visual.forEach(item => {
                    visualSection.appendChild(createMediaItem(item));
                });
                container.appendChild(visualSection);
            }
        }

        function createMediaItem(item) {
            const div = document.createElement('div');
            div.className = 'media-item';
            div.id = `media-item-${item.id}`;
            
            // Build title with author
            let titleDisplay = item.title;
            if (item.author) titleDisplay += ` - ${item.author}`;
            if (item.volume_episode) titleDisplay += ` (${item.volume_episode})`;
            
            // Get media type emoji and label
            const typeInfo = {
                'book': 'üìñ KsiƒÖ≈ºka',
                'comic': 'üì∞ Komiks',
                'movie': 'üé¨ Film',
                'series': 'üì∫ Serial',
                'anime': 'üéå Anime',
                'cartoon': 'üé® Bajka'
            };
            const typeLabel = typeInfo[item.media_type] || item.media_type;
            
            const content = `
                <div class="media-item-view" id="view-${item.id}">
                    <div class="media-item-header">
                        <strong>${titleDisplay}</strong>
                        <div class="media-item-buttons">
                            <button data-action="addAgain" data-id="${item.id}" class="action-btn" title="Dodaj ponownie (re-watch/re-read)">Dodaj ponownie</button>
                            <button data-action="editMedia" data-id="${item.id}" class="action-btn">Edytuj</button>
                            <button data-action="deleteMedia" data-id="${item.id}" class="delete-btn">Usu≈Ñ</button>
                        </div>
                    </div>
                    <div class="media-item-details">
                        <span>${typeLabel}</span>
                        <span>Od: ${formatDate(item.start_date)}</span>
                        <span>Do: ${formatDate(item.end_date)}</span>
                        <span>${calculateDays(item.start_date, item.end_date)} dni</span>
                    </div>
                    ${item.tags ? `<div class="media-item-tags">üè∑Ô∏è ${item.tags}</div>` : ''}
                    ${item.notes ? `<div class="media-item-notes">${item.notes}</div>` : ''}
                </div>
                <div class="media-item-edit" id="edit-${item.id}" style="display: none;">
                    <div class="edit-form">
                        <div class="form-group">
                            <label>Tytu≈Ç:</label>
                            <input type="text" id="edit-title-${item.id}" value="${item.title}" />
                        </div>
                        <div class="form-group">
                            <label>Autor:</label>
                            <input type="text" id="edit-author-${item.id}" value="${item.author || ''}" />
                        </div>
                        <div class="form-group">
                            <label>Typ:</label>
                            <select id="edit-type-${item.id}">
                                <option value="book" ${item.media_type === 'book' ? 'selected' : ''}>üìñ KsiƒÖ≈ºka</option>
                                <option value="comic" ${item.media_type === 'comic' ? 'selected' : ''}>üì∞ Komiks</option>
                                <option value="movie" ${item.media_type === 'movie' ? 'selected' : ''}>üé¨ Film</option>
                                <option value="series" ${item.media_type === 'series' ? 'selected' : ''}>üì∫ Serial</option>
                                <option value="anime" ${item.media_type === 'anime' ? 'selected' : ''}>üéå Anime</option>
                                <option value="cartoon" ${item.media_type === 'cartoon' ? 'selected' : ''}>üé® Bajka</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Tom/Odcinek:</label>
                            <input type="text" id="edit-volume-${item.id}" value="${item.volume_episode || ''}" />
                        </div>
                        <div class="form-group">
                            <label>Data rozpoczƒôcia:</label>
                            <input type="date" id="edit-start-${item.id}" value="${item.start_date}" />
                        </div>
                        <div class="form-group">
                            <label>Data zako≈Ñczenia:</label>
                            <input type="date" id="edit-end-${item.id}" value="${item.end_date}" />
                        </div>
                        <div class="form-group">
                            <label>Tagi:</label>
                            <input type="text" id="edit-tags-${item.id}" value="${item.tags || ''}" />
                        </div>
                        <div class="form-group">
                            <label>Notatki:</label>
                            <textarea id="edit-notes-${item.id}" rows="2">${item.notes || ''}</textarea>
                        </div>
                        <div class="edit-buttons">
                            <button data-action="updateMedia" data-id="${item.id}" class="save-btn">Zapisz</button>
                            <button data-action="cancelEdit" data-id="${item.id}" class="cancel-btn">Anuluj</button>
                        </div>
                    </div>
                </div>
            `;
            
            div.innerHTML = content;
            return div;
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('pl-PL');
        }

        function calculateDays(startStr, endStr) {
            const start = new Date(startStr);
            const end = new Date(endStr);
            const diffTime = Math.abs(end - start);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
            return diffDays;
        }

        document.getElementById('addMediaForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                title: document.getElementById('title').value,
                author: document.getElementById('author').value,
                media_type: document.getElementById('mediaType').value,
                volume_episode: document.getElementById('volumeEpisode').value,
                start_date: document.getElementById('startDate').value,
                end_date: document.getElementById('endDate').value,
                tags: document.getElementById('tags').value,
                notes: document.getElementById('notes').value
            };
            
            try {
                const response = await fetch('/api/media', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                if (response.ok) {
                    showToast('Pozycja zosta≈Ça dodana!', 'success');
                    this.reset();
                    loadMedia();
                } else {
                    const error = await response.json();
                    showToast('B≈ÇƒÖd: ' + error.error, 'error');
                }
            } catch (error) {
                console.error('Error adding media:', error);
                showToast('WystƒÖpi≈Ç b≈ÇƒÖd podczas dodawania pozycji.', 'error');
            }
        });

        async function deleteMedia(id) {
            if (!confirm('Czy na pewno chcesz usunƒÖƒá tƒô pozycjƒô?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/media/${id}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showToast('Pozycja zosta≈Ça usuniƒôta!', 'success');
                    loadMedia();
                } else {
                    showToast('B≈ÇƒÖd podczas usuwania pozycji.', 'error');
                }
            } catch (error) {
                console.error('Error deleting media:', error);
                showToast('WystƒÖpi≈Ç b≈ÇƒÖd podczas usuwania pozycji.', 'error');
            }
        }

        function editMedia(id) {
            // Hide view mode and show edit mode
            document.getElementById(`view-${id}`).style.display = 'none';
            document.getElementById(`edit-${id}`).style.display = 'block';
        }

        function cancelEdit(id) {
            // Hide edit mode and show view mode
            document.getElementById(`edit-${id}`).style.display = 'none';
            document.getElementById(`view-${id}`).style.display = 'block';
        }

        async function updateMedia(id) {
            const formData = {
                title: document.getElementById(`edit-title-${id}`).value,
                author: document.getElementById(`edit-author-${id}`).value,
                media_type: document.getElementById(`edit-type-${id}`).value,
                volume_episode: document.getElementById(`edit-volume-${id}`).value,
                start_date: document.getElementById(`edit-start-${id}`).value,
                end_date: document.getElementById(`edit-end-${id}`).value,
                tags: document.getElementById(`edit-tags-${id}`).value,
                notes: document.getElementById(`edit-notes-${id}`).value
            };
            
            try {
                const response = await fetch(`/api/media/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                if (response.ok) {
                    showToast('Pozycja zosta≈Ça zaktualizowana!', 'success');
                    loadMedia();
                } else {
                    const error = await response.json();
                    showToast('B≈ÇƒÖd: ' + (error.error || 'Nie uda≈Ço siƒô zaktualizowaƒá'), 'error');
                }
            } catch (error) {
                console.error('Error updating media:', error);
                showToast('WystƒÖpi≈Ç b≈ÇƒÖd podczas aktualizacji pozycji.', 'error');
            }
        }

        function addAgain(id) {
            // Find the media item in allMedia array
            const item = allMedia.find(m => m.id === id);
            if (!item) return;
            
            // Expand the form if collapsed
            const formContainer = document.getElementById('formContainer');
            const toggleIcon = document.getElementById('toggleIcon');
            if (formContainer.style.maxHeight === '0px' || !formContainer.style.maxHeight) {
                formContainer.style.maxHeight = '1000px';
                toggleIcon.textContent = '‚ñ≤';
            }
            
            // Pre-fill form with title, author, and type, but clear dates, volume, tags, and notes
            document.getElementById('title').value = item.title;
            document.getElementById('author').value = item.author || '';
            document.getElementById('mediaType').value = item.media_type;
            document.getElementById('volumeEpisode').value = '';
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            document.getElementById('tags').value = '';
            document.getElementById('notes').value = '';
            
            // Scroll to form
            document.querySelector('.add-media-section').scrollIntoView({ behavior: 'smooth', block: 'start' });
            
            // Focus on volume/episode or start date input
            setTimeout(() => {
                document.getElementById('volumeEpisode').focus();
            }, 500);
            
            showToast('Formularz wype≈Çniony - wybierz nowe daty i ewentualnie tom/odcinek', 'success');
        }

        // Event delegation for all click events
        document.addEventListener('click', function(event) {
            const target = event.target;
            const action = target.getAttribute('data-action');
            
            if (!action) return;
            
            // Don't prevent default for links and form submissions
            if (target.tagName === 'BUTTON') {
                event.preventDefault();
            }
            event.stopPropagation();
            
            switch(action) {
                case 'changeYear':
                    const delta = parseInt(target.getAttribute('data-delta'));
                    changeYear(delta);
                    break;
                case 'toggleForm':
                    toggleForm();
                    break;
                case 'toggleSummary':
                    toggleSummary();
                    break;
                case 'generateSummary':
                    generateSummary();
                    break;
                case 'closeToast':
                    target.parentElement.remove();
                    break;
                case 'addAgain':
                    const addAgainId = parseInt(target.getAttribute('data-id'));
                    addAgain(addAgainId);
                    break;
                case 'editMedia':
                    const editId = parseInt(target.getAttribute('data-id'));
                    editMedia(editId);
                    break;
                case 'deleteMedia':
                    const deleteId = parseInt(target.getAttribute('data-id'));
                    deleteMedia(deleteId);
                    break;
                case 'updateMedia':
                    const updateId = parseInt(target.getAttribute('data-id'));
                    updateMedia(updateId);
                    break;
                case 'cancelEdit':
                    const cancelId = parseInt(target.getAttribute('data-id'));
                    cancelEdit(cancelId);
                    break;
            }
        });
    </script>
</body>
</html>
